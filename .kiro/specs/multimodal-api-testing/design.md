# 多模态 API 功能完整度测试 - 设计文档

## 1. 设计概述

本设计文档描述了如何系统地测试 Orchids API 项目的多模态功能完整度，包括测试策略、测试架构和实现方案。

## 2. 当前状态分析

### 2.1 已实现功能

#### 文本聊天功能 ✅
- **路由**：`/v1/chat/completions` 已注册
- **处理器**：`HandleOpenAIChat` 已实现
- **功能**：完整支持流式和非流式响应
- **状态**：可正常使用

#### 图像生成功能 ⚠️
- **路由**：未注册（**关键问题**）
- **处理器**：`HandleOpenAIImages` 已实现
- **客户端方法**：`GenerateImage` 已实现
- **状态**：代码完整但无法访问

#### 视频生成功能 ⚠️
- **路由**：未注册（**关键问题**）
- **处理器**：`HandleOpenAIVideos` 已实现
- **客户端方法**：`GenerateVideo` 已实现
- **状态**：代码完整但无法访问

### 2.2 问题根因分析

在 `cmd/server/main.go` 中，只注册了以下路由：
```go
mux.HandleFunc("/v1/messages", h.HandleMessages)
mux.HandleFunc("/v1/chat/completions", h.HandleOpenAIChat)
mux.HandleFunc("/v1/models", h.HandleOpenAIModels)
```

缺少：
```go
mux.HandleFunc("/v1/images/generations", h.HandleOpenAIImages)
mux.HandleFunc("/v1/videos/generations", h.HandleOpenAIVideos)
```

## 3. 测试架构设计

### 3.1 测试层次结构

```
测试层次
├── 单元测试层
│   ├── 处理器逻辑测试
│   ├── 客户端方法测试
│   └── 数据转换测试
├── 集成测试层
│   ├── HTTP 端点测试
│   ├── 负载均衡测试
│   └── 错误处理测试
└── 端到端测试层
    ├── 完整流程测试
    ├── 测试页面验证
    └── 实际生成验证
```

### 3.2 测试工具选择

- **测试框架**：Go 标准库 `testing`
- **HTTP 测试**：`httptest` 包
- **断言库**：自定义断言函数
- **测试数据**：JSON 文件

## 4. 测试实现方案

### 4.1 测试文件结构

```
test/
├── api_test.go              # API 端点测试
├── handler_test.go          # 处理器测试
├── integration_test.go      # 集成测试
├── testdata/
│   ├── chat_request.json    # 聊天请求样本
│   ├── image_request.json   # 图像请求样本
│   └── video_request.json   # 视频请求样本
└── test_report.md           # 测试报告模板
```

### 4.2 测试用例设计

#### 4.2.1 文本聊天测试用例

**TC-CHAT-001：基本聊天功能**
- **输入**：简单文本消息
- **预期**：返回 AI 响应
- **验证**：响应格式、状态码、内容完整性

**TC-CHAT-002：流式响应**
- **输入**：启用 stream 参数
- **预期**：SSE 流式响应
- **验证**：事件格式、数据完整性

**TC-CHAT-003：模型选择**
- **输入**：不同模型名称
- **预期**：正确映射到后端模型
- **验证**：模型映射逻辑

**TC-CHAT-004：错误处理**
- **输入**：无效请求
- **预期**：返回适当错误
- **验证**：错误码、错误消息

#### 4.2.2 图像生成测试用例

**TC-IMAGE-001：基本图像生成**
- **输入**：文本提示词
- **预期**：返回图像 URL
- **验证**：响应格式、URL 有效性

**TC-IMAGE-002：尺寸选择**
- **输入**：不同尺寸参数
- **预期**：生成对应尺寸图像
- **验证**：尺寸参数传递

**TC-IMAGE-003：路由可访问性**
- **输入**：HTTP POST 请求
- **预期**：端点可访问（当前失败）
- **验证**：状态码 200 而非 404

**TC-IMAGE-004：错误处理**
- **输入**：空提示词
- **预期**：返回 400 错误
- **验证**：参数验证

#### 4.2.3 视频生成测试用例

**TC-VIDEO-001：基本视频生成**
- **输入**：文本提示词
- **预期**：返回视频 URL
- **验证**：响应格式、URL 有效性

**TC-VIDEO-002：尺寸选择**
- **输入**：不同尺寸参数
- **预期**：生成对应尺寸视频
- **验证**：尺寸参数传递

**TC-VIDEO-003：路由可访问性**
- **输入**：HTTP POST 请求
- **预期**：端点可访问（当前失败）
- **验证**：状态码 200 而非 404

**TC-VIDEO-004：错误处理**
- **输入**：空提示词
- **预期**：返回 400 错误
- **验证**：参数验证

### 4.3 测试数据设计

#### 聊天请求样本
```json
{
  "model": "claude-opus-4-5",
  "messages": [
    {
      "role": "user",
      "content": "你好，请介绍一下你自己"
    }
  ],
  "stream": false
}
```

#### 图像请求样本
```json
{
  "prompt": "一只可爱的小猫在花园里玩耍",
  "size": "1024x1024",
  "n": 1
}
```

#### 视频请求样本
```json
{
  "prompt": "一只可爱的小猫在花园里玩耍",
  "size": "1024x1024",
  "n": 1
}
```

## 5. 修复方案设计

### 5.1 路由注册修复

**文件**：`cmd/server/main.go`

**修改位置**：在现有路由注册后添加

**修改内容**：
```go
// 在 mux.HandleFunc("/v1/models", h.HandleOpenAIModels) 之后添加
mux.HandleFunc("/v1/images/generations", h.HandleOpenAIImages)
mux.HandleFunc("/v1/videos/generations", h.HandleOpenAIVideos)
```

**影响分析**：
- 无破坏性变更
- 仅添加新路由
- 不影响现有功能

### 5.2 测试页面验证

**验证步骤**：
1. 修复路由注册
2. 重新编译和部署
3. 访问测试页面
4. 测试图像生成功能
5. 测试视频生成功能

## 6. 测试执行计划

### 6.1 阶段一：修复路由（优先级：高）
- 修改 `cmd/server/main.go`
- 添加缺失的路由注册
- 本地编译验证

### 6.2 阶段二：编写测试脚本
- 创建测试文件结构
- 实现单元测试
- 实现集成测试

### 6.3 阶段三：执行测试
- 运行自动化测试
- 记录测试结果
- 生成测试报告

### 6.4 阶段四：手动验证
- 通过测试页面验证
- 验证实际生成结果
- 记录用户体验问题

## 7. 测试报告格式

### 7.1 测试摘要
- 测试日期和时间
- 测试环境信息
- 测试执行人员

### 7.2 测试结果统计
- 总测试用例数
- 通过用例数
- 失败用例数
- 跳过用例数

### 7.3 详细测试结果
- 每个测试用例的执行结果
- 失败原因分析
- 截图和日志

### 7.4 问题清单
- 问题描述
- 严重程度
- 修复建议
- 责任人

### 7.5 改进建议
- 代码质量改进
- 功能增强建议
- 性能优化建议

## 8. 成功标准

### 8.1 功能完整性
- ✅ 文本聊天功能正常工作
- ⚠️ 图像生成功能需要修复路由
- ⚠️ 视频生成功能需要修复路由
- ✅ 测试页面能够加载

### 8.2 测试覆盖率
- 单元测试覆盖率 ≥ 80%
- 集成测试覆盖所有 API 端点
- 端到端测试覆盖主要用户场景

### 8.3 质量标准
- 所有测试用例通过
- 无严重缺陷
- 文档完整准确

## 9. 风险和缓解措施

### 9.1 风险识别

**风险 1：上游 API 不可用**
- **影响**：无法测试实际生成功能
- **缓解**：使用 mock 数据进行测试

**风险 2：测试环境不稳定**
- **影响**：测试结果不可靠
- **缓解**：使用本地测试环境

**风险 3：账号配额限制**
- **影响**：无法完成大量测试
- **缓解**：限制测试频率，使用测试账号

### 9.2 依赖项

- Go 1.21+
- Docker（用于部署）
- 有效的 API 账号
- 网络连接

## 10. 时间估算

- 路由修复：30 分钟
- 测试脚本编写：2-3 小时
- 测试执行：1 小时
- 报告编写：1 小时
- **总计**：约 5 小时

## 11. 附录

### 11.1 相关文件清单
- `cmd/server/main.go` - 主服务器入口
- `internal/handler/openai.go` - OpenAI 兼容处理器
- `internal/client/client.go` - 客户端实现
- `web/static/test.html` - 测试页面

### 11.2 参考文档
- OpenAI API 文档
- 项目 README.md
- 项目 PROJECT_DOCUMENTATION.md
